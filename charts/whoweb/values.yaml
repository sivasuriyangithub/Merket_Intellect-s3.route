# This is a YAML-formatted file.
# Declare variables to be passed into your templates.
image:
  pullPolicy: IfNotPresent
  repository:
  tag:
basedomain: whoknows.com
service:
  name: xperweb
  type: NodePort
  ports:
    - name: http
      port: 80
      targetPort: 5000
  sessionAffinity: ClientIP
  externalPort: 80
  annotations:
    fabric8.io/expose: "true"
    fabric8.io/ingress.annotations: "kubernetes.io/ingress.class: nginx"
deployment:
  envConfigMapRef: "whoweb-config"
  envSecretRef: "whoweb-secrets"
  reloadOnEnvChange: 1
  readinessProbe:
    httpGet:
      path: /readiness
      port: 5000
      initialDelaySeconds: 20
      timeoutSeconds: 5
  livenessProbe:
    httpGet:
      path: /liveness
      port: 5000
  strategy:
    rollingUpdate:
      maxSurge: 51%
      maxUnavailable: 25%
hpa:
  minReplicas: 1
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      targetAverageUtilization: 60
  - type: Resource
    resource:
      name: memory
      targetAverageUtilization: 80
resources:
  requests:
    cpu: "500m"
    memory: "1Gi"
selfInitContainer:
  name: xperweb-static-release
  volumeMounts:
    - name: google-cloud-key
      mountPath: /var/secrets/google
  envFrom:
    - configMapRef:
        name: "xperweb-config"
    - secretRef:
        name: "xperweb-secrets"
  env:
    - name: GOOGLE_APPLICATION_CREDENTIALS
      value: "/var/secrets/google/key.json"
    - name: STATIC_ASSET_BUCKET
      valueFrom:
        configMapKeyRef:
          name: "xperweb-config"
          key: STATIC_ASSET_BUCKET
  command: ["python2.7", "-u", "xperweb/collect_static.py"]
volumes:
  - name: google-cloud-key
    secret:
      secretName: static-bucket-account
